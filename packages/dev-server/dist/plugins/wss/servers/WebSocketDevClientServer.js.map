{"version":3,"file":"WebSocketDevClientServer.js","names":["WebSocketServer","WebSocketDevClientServer","clients","Map","nextClientId","constructor","fastify","processMessage","message","type","body","JSON","parse","level","log","error","issuer","msg","data","warn","info","onConnection","socket","clientId","set","onClose","delete","addEventListener","event","toString"],"sources":["../../../../src/plugins/wss/servers/WebSocketDevClientServer.ts"],"sourcesContent":["import WebSocket from 'ws';\nimport type { FastifyInstance } from 'fastify';\nimport { WebSocketServer } from '../WebSocketServer';\n\n/**\n * Class for creating a WebSocket server for communication with React Native clients.\n * All client logs - logs from React Native application - are processed here.\n *\n * @category Development server\n */\nexport class WebSocketDevClientServer extends WebSocketServer {\n  private clients = new Map<string, WebSocket>();\n  private nextClientId = 0;\n\n  /**\n   * Create new instance of WebSocketDevClientServer and attach it to the given Fastify instance.\n   * Any logging information, will be passed through standard `fastify.log` API.\n   *\n   * @param fastify Fastify instance to attach the WebSocket server to.\n   */\n  constructor(fastify: FastifyInstance) {\n    super(fastify, '/__client');\n  }\n\n  /**\n   * Process client message.\n   *\n   * @param message Stringified client message.\n   */\n  processMessage(message: string) {\n    const { type, ...body } = JSON.parse(message);\n    switch (type) {\n      case 'client-log':\n        if (body.level === 'error') {\n          this.fastify.log.error({ issuer: 'Console', msg: body.data });\n        } else if (body.level === 'warn') {\n          this.fastify.log.warn({ issuer: 'Console', msg: body.data });\n        } else {\n          this.fastify.log.info({ issuer: 'Console', msg: body.data });\n        }\n        break;\n      default:\n        this.fastify.log.warn({ msg: 'Unknown client message', message });\n    }\n  }\n\n  /**\n   * Process new WebSocket connection from client application.\n   *\n   * @param socket Incoming client's WebSocket connection.\n   */\n  onConnection(socket: WebSocket) {\n    const clientId = `client#${this.nextClientId++}`;\n    this.clients.set(clientId, socket);\n\n    this.fastify.log.info({ msg: 'React Native client connected', clientId });\n    this.clients.set(clientId, socket);\n\n    const onClose = () => {\n      this.fastify.log.info({\n        msg: 'React Native client disconnected',\n        clientId,\n      });\n      this.clients.delete(clientId);\n    };\n\n    socket.addEventListener('error', onClose);\n    socket.addEventListener('close', onClose);\n    socket.addEventListener('message', (event) => {\n      this.processMessage(event.data.toString());\n    });\n  }\n}\n"],"mappings":"SAESA,eAAe;AAExB;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,MAAMC,wBAAwB,SAASD,eAAe,CAAC;EACpDE,OAAO,GAAG,IAAIC,GAAG,CAAoB,CAAC;EACtCC,YAAY,GAAG,CAAC;;EAExB;AACF;AACA;AACA;AACA;AACA;EACEC,WAAWA,CAACC,OAAwB,EAAE;IACpC,KAAK,CAACA,OAAO,EAAE,WAAW,CAAC;EAC7B;;EAEA;AACF;AACA;AACA;AACA;EACEC,cAAcA,CAACC,OAAe,EAAE;IAC9B,MAAM;MAAEC,IAAI;MAAE,GAAGC;IAAK,CAAC,GAAGC,IAAI,CAACC,KAAK,CAACJ,OAAO,CAAC;IAC7C,QAAQC,IAAI;MACV,KAAK,YAAY;QACf,IAAIC,IAAI,CAACG,KAAK,KAAK,OAAO,EAAE;UAC1B,IAAI,CAACP,OAAO,CAACQ,GAAG,CAACC,KAAK,CAAC;YAAEC,MAAM,EAAE,SAAS;YAAEC,GAAG,EAAEP,IAAI,CAACQ;UAAK,CAAC,CAAC;QAC/D,CAAC,MAAM,IAAIR,IAAI,CAACG,KAAK,KAAK,MAAM,EAAE;UAChC,IAAI,CAACP,OAAO,CAACQ,GAAG,CAACK,IAAI,CAAC;YAAEH,MAAM,EAAE,SAAS;YAAEC,GAAG,EAAEP,IAAI,CAACQ;UAAK,CAAC,CAAC;QAC9D,CAAC,MAAM;UACL,IAAI,CAACZ,OAAO,CAACQ,GAAG,CAACM,IAAI,CAAC;YAAEJ,MAAM,EAAE,SAAS;YAAEC,GAAG,EAAEP,IAAI,CAACQ;UAAK,CAAC,CAAC;QAC9D;QACA;MACF;QACE,IAAI,CAACZ,OAAO,CAACQ,GAAG,CAACK,IAAI,CAAC;UAAEF,GAAG,EAAE,wBAAwB;UAAET;QAAQ,CAAC,CAAC;IACrE;EACF;;EAEA;AACF;AACA;AACA;AACA;EACEa,YAAYA,CAACC,MAAiB,EAAE;IAC9B,MAAMC,QAAQ,GAAG,UAAU,IAAI,CAACnB,YAAY,EAAE,EAAE;IAChD,IAAI,CAACF,OAAO,CAACsB,GAAG,CAACD,QAAQ,EAAED,MAAM,CAAC;IAElC,IAAI,CAAChB,OAAO,CAACQ,GAAG,CAACM,IAAI,CAAC;MAAEH,GAAG,EAAE,+BAA+B;MAAEM;IAAS,CAAC,CAAC;IACzE,IAAI,CAACrB,OAAO,CAACsB,GAAG,CAACD,QAAQ,EAAED,MAAM,CAAC;IAElC,MAAMG,OAAO,GAAGA,CAAA,KAAM;MACpB,IAAI,CAACnB,OAAO,CAACQ,GAAG,CAACM,IAAI,CAAC;QACpBH,GAAG,EAAE,kCAAkC;QACvCM;MACF,CAAC,CAAC;MACF,IAAI,CAACrB,OAAO,CAACwB,MAAM,CAACH,QAAQ,CAAC;IAC/B,CAAC;IAEDD,MAAM,CAACK,gBAAgB,CAAC,OAAO,EAAEF,OAAO,CAAC;IACzCH,MAAM,CAACK,gBAAgB,CAAC,OAAO,EAAEF,OAAO,CAAC;IACzCH,MAAM,CAACK,gBAAgB,CAAC,SAAS,EAAGC,KAAK,IAAK;MAC5C,IAAI,CAACrB,cAAc,CAACqB,KAAK,CAACV,IAAI,CAACW,QAAQ,CAAC,CAAC,CAAC;IAC5C,CAAC,CAAC;EACJ;AACF","ignoreList":[]}
{"version":3,"file":"createServer.js","names":["Writable","Fastify","fastifySensible","middie","createDevMiddleware","debuggerUIMiddleware","openURLMiddleware","openStackFrameInEditorMiddleware","multipartPlugin","compilerPlugin","apiPlugin","wssPlugin","faviconPlugin","Internal","symbolicatePlugin","devtoolsPlugin","createServer","config","delegate","instance","logger","level","stream","write","chunk","_encoding","callback","log","JSON","parse","toString","onMessage","wss","apiServer","send","options","https","undefined","notifyBuildStart","platform","event","EventTypes","BuildStart","notifyBuildEnd","BuildEnd","broadcastToHmrClients","clientIds","hmrServer","broadcastToMessageClients","method","params","messageServer","broadcast","devMiddleware","projectRoot","rootDir","serverBaseUrl","host","port","unstable_experiments","enableNewDebugger","experiments","experimentalDebugger","register","endpoints","websocketEndpoints","prefix","use","addHook","request","reply","payload","header","pathname","url","split","endsWith","middleware","get","messages","getHello","getStatus","start","listen","stop","close"],"sources":["../src/createServer.ts"],"sourcesContent":["import { Writable } from 'stream';\nimport Fastify from 'fastify';\nimport fastifySensible from '@fastify/sensible';\nimport middie from '@fastify/middie';\n// eslint-disable-next-line import/no-unresolved -- no main field in package.json\nimport { createDevMiddleware } from '@react-native/dev-middleware';\nimport { debuggerUIMiddleware } from '@react-native-community/cli-debugger-ui';\nimport {\n  openURLMiddleware,\n  openStackFrameInEditorMiddleware,\n} from '@react-native-community/cli-server-api';\nimport multipartPlugin from './plugins/multipart';\nimport compilerPlugin from './plugins/compiler';\nimport apiPlugin from './plugins/api';\nimport wssPlugin from './plugins/wss';\nimport faviconPlugin from './plugins/favicon';\nimport { Internal, Server } from './types';\nimport symbolicatePlugin from './plugins/symbolicate';\nimport devtoolsPlugin from './plugins/devtools';\n\n/**\n * Create instance of development server, powered by Fastify.\n *\n * @param config Server configuration.\n * @returns `start` and `stop` functions as well as an underlying Fastify `instance`.\n */\nexport async function createServer(config: Server.Config) {\n  let delegate: Server.Delegate;\n\n  /** Fastify instance powering the development server. */\n  const instance = Fastify({\n    logger: {\n      level: 'trace',\n      stream: new Writable({\n        write: (chunk, _encoding, callback) => {\n          const log = JSON.parse(chunk.toString());\n          delegate?.logger.onMessage(log);\n          instance.wss?.apiServer.send(log);\n          callback();\n        },\n      }),\n    },\n    ...(config.options.https ? { https: config.options.https } : undefined),\n  });\n\n  delegate = config.delegate({\n    log: instance.log,\n    notifyBuildStart: (platform) => {\n      instance.wss.apiServer.send({\n        event: Internal.EventTypes.BuildStart,\n        platform,\n      });\n    },\n    notifyBuildEnd: (platform) => {\n      instance.wss.apiServer.send({\n        event: Internal.EventTypes.BuildEnd,\n        platform,\n      });\n    },\n    broadcastToHmrClients: (event, platform, clientIds) => {\n      instance.wss.hmrServer.send(event, platform, clientIds);\n    },\n    broadcastToMessageClients: ({ method, params }) => {\n      instance.wss.messageServer.broadcast(method, params);\n    },\n  });\n\n  const devMiddleware = createDevMiddleware({\n    projectRoot: config.options.rootDir,\n    serverBaseUrl: `http://${config.options.host}:${config.options.port}`,\n    logger: instance.log,\n    unstable_experiments: {\n      enableNewDebugger: config.experiments?.experimentalDebugger,\n    },\n  });\n\n  // Register plugins\n  await instance.register(fastifySensible);\n  await instance.register(middie);\n  await instance.register(wssPlugin, {\n    options: {\n      ...config.options,\n      endpoints: devMiddleware.websocketEndpoints,\n    },\n    delegate,\n  });\n  await instance.register(multipartPlugin);\n  await instance.register(apiPlugin, {\n    delegate,\n    prefix: '/api',\n  });\n  await instance.register(compilerPlugin, {\n    delegate,\n  });\n\n  // TODO: devtoolsPlugin and the following deprecated remote debugger middlewares should be removed after\n  //  the new (experimental) debugger is stable AND the remote debugger is finally removed from the React Native core.\n  //  When that happens remember to remove @react-native-community/cli-server-api & @react-native-community/cli-debugger-ui\n  //  from the dependencies.\n  await instance.register(devtoolsPlugin, {\n    options: config.options,\n  });\n  instance.use('/debugger-ui', debuggerUIMiddleware());\n  instance.use('/open-url', openURLMiddleware);\n  instance.use('/open-stack-frame', openStackFrameInEditorMiddleware);\n\n  await instance.register(symbolicatePlugin, {\n    delegate,\n  });\n\n  // below is to prevent showing `GET 400 /favicon.ico`\n  // errors in console when requesting the bundle via browser\n  await instance.register(faviconPlugin);\n\n  instance.addHook('onSend', async (request, reply, payload) => {\n    reply.header('X-Content-Type-Options', 'nosniff');\n    reply.header('X-React-Native-Project-Root', config.options.rootDir);\n\n    const [pathname] = request.url.split('?');\n    if (pathname.endsWith('.map')) {\n      reply.header('Access-Control-Allow-Origin', 'devtools://devtools');\n    }\n\n    return payload;\n  });\n\n  // Register dev middleware\n  instance.use(devMiddleware.middleware);\n\n  // Register routes\n  instance.get('/', async () => delegate.messages.getHello());\n  instance.get('/status', async () => delegate.messages.getStatus());\n\n  /** Start the development server. */\n  async function start() {\n    await instance.listen({\n      port: config.options.port,\n      host: config.options.host,\n    });\n  }\n\n  /** Stop the development server. */\n  async function stop() {\n    await instance.close();\n  }\n\n  return {\n    start,\n    stop,\n    instance,\n  };\n}\n"],"mappings":"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","ignoreList":[]}
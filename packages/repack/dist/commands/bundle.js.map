{"version":3,"file":"bundle.js","names":["_promises","require","_fsExtra","_interopRequireDefault","_jsonExt","_webpack","_env","_loadWebpackConfig","_utils","_getWebpackConfigPath","e","__esModule","default","bundle","_","config","args","webpackConfigPath","getWebpackConfigPath","root","webpackConfig","cliOptions","reactNativePath","command","arguments","entryFile","Error","verbose","process","argv","includes","env","VERBOSE_ENV_KEY","webpackEnvOptions","getWebpackEnvOptions","loadWebpackConfig","errorHandler","error","stats","console","exit","hasErrors","compilation","errors","forEach","json","undefined","log","statOptions","preset","compiler","options","statsStream","stringifyStream","toJson","outputStream","fs","createWriteStream","pipeline","webpack","Promise","resolve","watch","hooks","watchClose","tap","watchOptions","run","close","closeErr"],"sources":["../../src/commands/bundle.ts"],"sourcesContent":["import { pipeline } from 'node:stream/promises';\nimport { Config } from '@react-native-community/cli-types';\nimport fs from 'fs-extra';\nimport { stringifyStream } from '@discoveryjs/json-ext';\nimport webpack from 'webpack';\nimport { VERBOSE_ENV_KEY } from '../env';\nimport { BundleArguments, CliOptions } from '../types';\nimport { loadWebpackConfig } from '../webpack/loadWebpackConfig';\nimport { getWebpackEnvOptions } from '../webpack/utils';\nimport { getWebpackConfigPath } from './utils/getWebpackConfigPath';\n\n/**\n * Bundle command for React Native CLI.\n * It runs Webpack, builds bundle and saves it alongside any other assets and Source Map\n * to filesystem.\n *\n * @param _ Original, non-parsed arguments that were provided when running this command.\n * @param config React Native CLI configuration object.\n * @param args Parsed command line arguments.\n *\n * @internal\n * @category CLI command\n */\nexport async function bundle(\n  _: string[],\n  config: Config,\n  args: BundleArguments\n) {\n  const webpackConfigPath = getWebpackConfigPath(\n    config.root,\n    args.webpackConfig\n  );\n\n  const cliOptions = {\n    config: {\n      root: config.root,\n      reactNativePath: config.reactNativePath,\n      webpackConfigPath,\n    },\n    command: 'bundle',\n    arguments: {\n      bundle: args,\n    },\n  } as CliOptions;\n\n  if (!args.entryFile) {\n    throw new Error(\"Option '--entry-file <path>' argument is missing\");\n  }\n\n  if (args.verbose ?? process.argv.includes('--verbose')) {\n    process.env[VERBOSE_ENV_KEY] = '1';\n  }\n\n  const webpackEnvOptions = getWebpackEnvOptions(cliOptions);\n  const webpackConfig = await loadWebpackConfig(\n    webpackConfigPath,\n    webpackEnvOptions\n  );\n\n  const errorHandler = async (error: Error | null, stats?: webpack.Stats) => {\n    if (error) {\n      console.error(error);\n      process.exit(2);\n    }\n\n    if (stats?.hasErrors()) {\n      stats.compilation?.errors?.forEach((e) => {\n        console.error(e);\n      });\n      process.exit(2);\n    }\n\n    if (args.json && stats !== undefined) {\n      console.log(`Writing compiler stats`);\n\n      let statOptions: Parameters<typeof stats.toJson>[0];\n      if (args.stats !== undefined) {\n        statOptions = { preset: args.stats };\n      } else if (typeof compiler.options.stats === 'boolean') {\n        statOptions = compiler.options.stats\n          ? { preset: 'normal' }\n          : { preset: 'none' };\n      } else {\n        statOptions = compiler.options.stats;\n      }\n\n      try {\n        // Stats can be fairly big at which point their JSON no longer fits into a single string.\n        // Approach was copied from `webpack-cli`: https://github.com/webpack/webpack-cli/blob/c03fb03d0aa73d21f16bd9263fd3109efaf0cd28/packages/webpack-cli/src/webpack-cli.ts#L2471-L2482\n        const statsStream = stringifyStream(stats.toJson(statOptions));\n        const outputStream = fs.createWriteStream(args.json);\n        await pipeline(statsStream, outputStream);\n        console.log(`Wrote compiler stats to ${args.json}`);\n      } catch (error) {\n        console.error(error);\n        process.exit(2);\n      }\n    }\n  };\n\n  const compiler = webpack(webpackConfig);\n\n  return new Promise<void>((resolve) => {\n    if (args.watch) {\n      compiler.hooks.watchClose.tap('bundle', resolve);\n      compiler.watch(webpackConfig.watchOptions ?? {}, errorHandler);\n    } else {\n      compiler.run((error, stats) => {\n        // make cache work: https://webpack.js.org/api/node/#run\n        compiler.close(async (closeErr) => {\n          if (closeErr) console.error(closeErr);\n          await errorHandler(error, stats);\n          resolve();\n        });\n      });\n    }\n  });\n}\n"],"mappings":"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","ignoreList":[]}
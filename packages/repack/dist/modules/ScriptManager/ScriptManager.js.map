{"version":3,"file":"ScriptManager.js","names":["EventEmitter","getWebpackContext","Script","NativeScriptManager","CACHE_NAME","CACHE_VERSION","CACHE_ENV","__DEV__","CACHE_KEY","join","ScriptManager","shared","__webpack_require__","repack","scriptManager","cache","cacheInitialized","resolvers","constructor","nativeScriptManager","Error","loadScriptCallback","push","parentPush","data","scriptId","caller","emit","bind","__destroy","undefined","Array","prototype","setStorage","storage","addResolver","resolver","priority","concat","sort","a","b","removeResolver","index","findIndex","item","splice","removeAllResolvers","initCache","cacheEntry","getItem","JSON","parse","saveCache","setItem","stringify","handleError","error","message","args","console","originalError","resolveScript","webpackContext","length","locator","resolve","url","script","from","cacheKey","uniqueId","shouldUpdateScript","fetch","shouldUpdateCache","getCacheData","toObject","shouldRefetch","loadScript","Promise","reject","onLoaded","on","code","removeListener","catch","prefetchScript","invalidateScripts","scriptIds","ids","Object","keys","forEach"],"sources":["../../../src/modules/ScriptManager/ScriptManager.ts"],"sourcesContent":["/* globals __DEV__, __webpack_require__ */\nimport EventEmitter from 'events';\nimport { getWebpackContext } from './getWebpackContext';\nimport { Script } from './Script';\nimport type { ScriptLocatorResolver, StorageApi } from './types';\nimport NativeScriptManager, {\n  NormalizedScriptLocator,\n} from './NativeScriptManager';\n\ntype Cache = Record<\n  string,\n  Pick<NormalizedScriptLocator, 'method' | 'url' | 'query' | 'headers' | 'body'>\n>;\n\nconst CACHE_NAME = 'Repack.ScriptManager.Cache';\nconst CACHE_VERSION = 'v4';\nconst CACHE_ENV = __DEV__ ? 'debug' : 'release';\n\nconst CACHE_KEY = [CACHE_NAME, CACHE_VERSION, CACHE_ENV].join('.');\n\n/* Options for resolver when adding it to a `ScriptManager`. */\nexport interface ResolverOptions {\n  /**\n   * Priority of the resolver. Defaults to `2`.\n   * Resolvers are called based on the highest priority,\n   * so higher the number, the higher priority the resolver gets.\n   */\n  priority?: number;\n}\n\n/**\n * A manager to ease resolution, downloading and executing additional code from:\n * - arbitrary JavaScript scripts\n * - Webpack chunks\n * - Webpack bundles\n * - Webpack MF containers\n *\n * ScriptManager is globally available under `ScriptManager.shared` in main bundle, chunks and containers.\n *\n * Use `ScriptManager.shared` instead of creating new instance of `ScriptManager`.\n *\n * This API is mainly useful, if you are working with any form of Code Splitting.\n *\n * `ScriptManager` is also an `EventEmitter` and emits the following events:\n * - `resolving` with `{ scriptId, caller }`\n * - `resolved` with `scriptId: string, caller?: string, locator: NormalizedScriptLocator, cache: boolean`\n * - `prefetching` with `scriptId: string, caller?: string, locator: NormalizedScriptLocator, cache: boolean`\n * - `loading` with `scriptId: string, caller?: string, locator: NormalizedScriptLocator, cache: boolean`\n * - `loaded` with `scriptId: string, caller?: string, locator: NormalizedScriptLocator, cache: boolean`\n * - `error` with `error: Error`\n *\n * Example of using this API with async Webpack chunk:\n * ```js\n * import * as React from 'react';\n * import { ScriptManager, Script } from '@callstack/repack/client';\n *\n * ScriptManager.shared.addResolver(async (scriptId) => {\n *   if (__DEV__) {\n *     return {\n *       url: Script.getDevServerURL(scriptId);\n *       cache: false,\n *     };\n *   }\n *\n *   return {\n *     url: Script.getRemoteURL(`http://domain.exaple/apps/${scriptId}`),\n *   };\n * });\n *\n * // ScriptManager.shared.loadScript is called internally when running `import()`\n * const TeacherModule = React.lazy(() => import('./Teacher.js'));\n * const StudentModule = React.lazy(() => import('./Student.js'));\n *\n * export function App({ role }) {\n *   if (role === 'teacher') {\n *     return <TeacherModule />;\n *   }\n *\n *   return <StudentModule />\n * }\n * ```\n */\nexport class ScriptManager extends EventEmitter {\n  static get shared(): ScriptManager {\n    if (!__webpack_require__.repack.shared.scriptManager) {\n      __webpack_require__.repack.shared.scriptManager = new ScriptManager();\n    }\n    return __webpack_require__.repack.shared.scriptManager;\n  }\n\n  protected cache: Cache = {};\n  protected cacheInitialized = false;\n  protected resolvers: [number, ScriptLocatorResolver][] = [];\n  protected storage?: StorageApi;\n\n  /**\n   * Constructs instance of `ScriptManager`.\n   *\n   * __Should not be called directly__ - use `ScriptManager.shared`.\n   *\n   * @internal\n   */\n  protected constructor(private nativeScriptManager = NativeScriptManager) {\n    super();\n\n    if (!nativeScriptManager) {\n      throw new Error(\n        'repack react-native module was not found.' +\n          (__DEV__ ? ' Did you forget to update native dependencies?' : '')\n      );\n    }\n\n    if (__webpack_require__.repack.shared.scriptManager) {\n      throw new Error(\n        'ScriptManager was already instantiated. Use ScriptManager.shared instead.'\n      );\n    }\n\n    __webpack_require__.repack.shared.loadScriptCallback.push = ((\n      parentPush: typeof Array.prototype.push,\n      ...data: string[][]\n    ) => {\n      const [[scriptId, caller]] = data;\n      this.emit('__loaded__', { scriptId, caller });\n      return parentPush(...data);\n    }).bind(\n      null,\n      __webpack_require__.repack.shared.loadScriptCallback.push.bind(\n        __webpack_require__.repack.shared.loadScriptCallback\n      )\n    );\n\n    __webpack_require__.repack.shared.scriptManager = this;\n  }\n\n  __destroy() {\n    __webpack_require__.repack.shared.scriptManager = undefined;\n    __webpack_require__.repack.shared.loadScriptCallback.push =\n      Array.prototype.push.bind(\n        __webpack_require__.repack.shared.loadScriptCallback\n      );\n  }\n\n  /**\n   * Sets a storage backend to cache resolved scripts locator data.\n   *\n   * The stored data is used to detect if scripts locator data of previously downloaded\n   * script hasn't changed to avoid over-fetching the script.\n   *\n   * @param storage Implementation of storage functions.\n   */\n  setStorage(storage?: StorageApi) {\n    this.storage = storage;\n  }\n\n  /**\n   * Adds new script locator resolver.\n   *\n   * Resolver is an async function to resolve script locator data - in other words, it's a function to\n   * tell the {@link ScriptManager} how to fetch the script.\n   *\n   * There's no limitation on what logic you can run inside this function - it can include:\n   * - fetching/loading remote config\n   * - fetching/loading feature flags\n   * - fetching/loading A/B testing data\n   * - calling native modules\n   * - running arbitrary logic\n   *\n   * @param resolver Resolver function to add.\n   * @param options Resolver options.\n   */\n  addResolver(\n    resolver: ScriptLocatorResolver,\n    { priority = 2 }: ResolverOptions = {}\n  ) {\n    this.resolvers = this.resolvers\n      .concat([[priority, resolver]])\n      .sort(([a], [b]) => b - a);\n  }\n\n  /**\n   * Removes previously added resolver.\n   *\n   * @param resolver Resolver function to remove.\n   * @returns `true` if resolver was found and removed, `false` otherwise.\n   */\n  removeResolver(resolver: ScriptLocatorResolver): boolean {\n    const index = this.resolvers.findIndex(([, item]) => item === resolver);\n    if (index > -1) {\n      this.resolvers.splice(index, 1);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Removes all previously added resolvers.\n   */\n  removeAllResolvers() {\n    this.resolvers = [];\n  }\n\n  protected async initCache() {\n    if (!this.cacheInitialized) {\n      const cacheEntry = await this.storage?.getItem(CACHE_KEY);\n      this.cache = cacheEntry ? JSON.parse(cacheEntry) : {};\n      this.cacheInitialized = true;\n    }\n  }\n\n  protected async saveCache() {\n    await this.storage?.setItem(CACHE_KEY, JSON.stringify(this.cache));\n  }\n\n  protected handleError(error: any, message: string, ...args: any[]): never {\n    console.error(message, ...args, { originalError: error });\n    this.emit('error', { message, args, originalError: error });\n    throw error;\n  }\n\n  /**\n   * Resolves a {@link Script} instance with normalized locator data.\n   *\n   * Resolution will use previously added (via `ScriptManager.shared.addResolver(...)`) resolvers\n   * in series, util one returns a locator data or will throw if no resolver handled the request.\n   *\n   * Use `ScriptManager.shared.on('resolving', ({ scriptId, caller }) => { })` to listen for when\n   * the script resolution begins.\n   *\n   * Use `ScriptManager.shared.on('resolved', (script) => { })` to listen for when\n   * the script's locator data is resolved.\n   *\n   * @param scriptId Id of the script to resolve.\n   * @param caller Name of the calling script - it can be for example: name of the bundle, chunk or container.\n   */\n  async resolveScript(\n    scriptId: string,\n    caller?: string,\n    webpackContext = getWebpackContext()\n  ): Promise<Script> {\n    await this.initCache();\n    try {\n      if (!this.resolvers.length) {\n        throw new Error(\n          'No script resolvers were added. Did you forget to call `ScriptManager.shared.addResolver(...)`?'\n        );\n      }\n\n      this.emit('resolving', { scriptId, caller });\n\n      let locator;\n      for (const [, resolve] of this.resolvers) {\n        locator = await resolve(scriptId, caller);\n        if (locator) {\n          break;\n        }\n      }\n\n      if (!locator) {\n        throw new Error(`No resolver was able to resolve script ${scriptId}`);\n      }\n\n      if (typeof locator.url === 'function') {\n        locator.url = locator.url(webpackContext);\n      }\n\n      const script = Script.from({ scriptId, caller }, locator, false);\n      const cacheKey = script.locator.uniqueId;\n\n      // Check if user provided a custom shouldUpdateScript function\n      if (locator.shouldUpdateScript) {\n        // If so, we need to wait for it to resolve\n        const fetch = await locator.shouldUpdateScript(\n          scriptId,\n          caller,\n          script.shouldUpdateCache(this.cache[cacheKey])\n        );\n\n        // If it returns true, we need to fetch the script\n        if (fetch) {\n          script.locator.fetch = true;\n          this.cache[cacheKey] = script.getCacheData();\n          await this.saveCache();\n        }\n\n        this.emit('resolved', script.toObject());\n\n        // if it returns false, we don't need to fetch the script\n        return script;\n      }\n\n      // If no custom shouldUpdateScript function was provided, we use the default behaviour\n      if (!this.cache[cacheKey]) {\n        script.locator.fetch = true;\n        this.cache[cacheKey] = script.getCacheData();\n        await this.saveCache();\n      } else if (script.shouldRefetch(this.cache[cacheKey])) {\n        script.locator.fetch = true;\n        this.cache[cacheKey] = script.getCacheData();\n        await this.saveCache();\n      }\n\n      this.emit('resolved', script.toObject());\n\n      return script;\n    } catch (error) {\n      this.handleError(\n        error,\n        '[ScriptManager] Failed while resolving script locator:',\n        { scriptId, caller }\n      );\n    }\n  }\n\n  /**\n   * Resolves given script's location, downloads and executes it.\n   * The execution of the code is handled internally by threading in React Native.\n   *\n   * Use `ScriptManager.shared.on('loading', (script) => { })` to listen for when\n   * the script is about to be loaded.\n   *\n   * Use `ScriptManager.shared.on('loaded', (script) => { })` to listen for when\n   * the script is loaded.\n   *\n   * @param scriptId Id of the script to load.\n   * @param caller Name of the calling script - it can be for example: name of the bundle, chunk or container.\n   */\n  async loadScript(\n    scriptId: string,\n    caller?: string,\n    webpackContext = getWebpackContext()\n  ) {\n    let script = await this.resolveScript(scriptId, caller, webpackContext);\n    return await new Promise<void>((resolve, reject) => {\n      (async () => {\n        const onLoaded = (data: { scriptId: string; caller?: string }) => {\n          if (data.scriptId === scriptId && data.caller === caller) {\n            this.emit('loaded', script.toObject());\n            resolve();\n          }\n        };\n\n        try {\n          this.emit('loading', script.toObject());\n          this.on('__loaded__', onLoaded);\n          await this.nativeScriptManager.loadScript(scriptId, script.locator);\n        } catch (error) {\n          const { code } = error as Error & { code: string };\n          this.handleError(\n            error,\n            '[ScriptManager] Failed to load script:',\n            code ? `[${code}]` : '',\n            script.toObject()\n          );\n        } finally {\n          this.removeListener('__loaded__', onLoaded);\n        }\n      })().catch((error) => {\n        reject(error);\n      });\n    });\n  }\n\n  /**\n   * Resolves given script's location and downloads it without executing.\n   * This function can be awaited to detect if the script was downloaded and for error handling.\n   *\n   * Use `ScriptManager.shared.on('prefetching', (script) => { })` to listen for when\n   * the script's prefetch beings.\n   *\n   * @param scriptId Id of the script to prefetch.\n   * @param caller Name of the calling script - it can be for example: name of the bundle, chunk or container.\n   */\n  async prefetchScript(\n    scriptId: string,\n    caller?: string,\n    webpackContext = getWebpackContext()\n  ) {\n    let script = await this.resolveScript(scriptId, caller, webpackContext);\n\n    try {\n      this.emit('prefetching', script.toObject());\n      await this.nativeScriptManager.prefetchScript(scriptId, script.locator);\n    } catch (error) {\n      const { code } = error as Error & { code: string };\n      this.handleError(\n        error,\n        '[ScriptManager] Failed to prefetch script:',\n        code ? `[${code}]` : '',\n        script.toObject()\n      );\n    }\n  }\n\n  /**\n   * Clears the cache (if configured in {@link ScriptManager.setStorage}) and removes downloaded\n   * files for given scripts from the filesystem. This function can be awaited to detect if the\n   * scripts were invalidated and for error handling.\n   *\n   * Use `ScriptManager.shared.on('invalidated', (scriptIds) => { })` to listen for when\n   * the invalidation completes.\n   *\n   * @param scriptIds Array of script ids to clear from cache and remove from filesystem.\n   * @returns Array of script ids that were invalidated.\n   */\n  async invalidateScripts(scriptIds: string[] = []) {\n    try {\n      await this.initCache();\n\n      const ids = scriptIds.length ? scriptIds : Object.keys(this.cache);\n      ids.forEach((scriptId) => delete this.cache[scriptId]);\n\n      await this.saveCache();\n      await this.nativeScriptManager.invalidateScripts(scriptIds);\n\n      this.emit('invalidated', ids);\n      return ids;\n    } catch (error) {\n      const { code } = error as Error & { code: string };\n      this.handleError(\n        error,\n        '[ScriptManager] Failed to invalidate scripts:',\n        code ? `[${code}]` : ''\n      );\n    }\n  }\n}\n"],"mappings":"AAAA;AACA,OAAOA,YAAY,MAAM,QAAQ;AACjC,SAASC,iBAAiB,QAAQ,qBAAqB;AACvD,SAASC,MAAM,QAAQ,UAAU;AAEjC,OAAOC,mBAAmB,MAEnB,uBAAuB;AAO9B,MAAMC,UAAU,GAAG,4BAA4B;AAC/C,MAAMC,aAAa,GAAG,IAAI;AAC1B,MAAMC,SAAS,GAAGC,OAAO,GAAG,OAAO,GAAG,SAAS;AAE/C,MAAMC,SAAS,GAAG,CAACJ,UAAU,EAAEC,aAAa,EAAEC,SAAS,CAAC,CAACG,IAAI,CAAC,GAAG,CAAC;;AAElE;;AAUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,MAAMC,aAAa,SAASV,YAAY,CAAC;EAC9C,WAAWW,MAAMA,CAAA,EAAkB;IACjC,IAAI,CAACC,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACG,aAAa,EAAE;MACpDF,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACG,aAAa,GAAG,IAAIJ,aAAa,CAAC,CAAC;IACvE;IACA,OAAOE,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACG,aAAa;EACxD;EAEUC,KAAK,GAAU,CAAC,CAAC;EACjBC,gBAAgB,GAAG,KAAK;EACxBC,SAAS,GAAsC,EAAE;EAG3D;AACF;AACA;AACA;AACA;AACA;AACA;EACYC,WAAWA,CAASC,mBAAmB,GAAGhB,mBAAmB,EAAE;IACvE,KAAK,CAAC,CAAC;IAAC,KADoBgB,mBAAmB,GAAnBA,mBAAmB;IAG/C,IAAI,CAACA,mBAAmB,EAAE;MACxB,MAAM,IAAIC,KAAK,CACb,2CAA2C,IACxCb,OAAO,GAAG,gDAAgD,GAAG,EAAE,CACpE,CAAC;IACH;IAEA,IAAIK,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACG,aAAa,EAAE;MACnD,MAAM,IAAIM,KAAK,CACb,2EACF,CAAC;IACH;IAEAR,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACU,kBAAkB,CAACC,IAAI,GAAG,CAAC,CAC3DC,UAAuC,EACvC,GAAGC,IAAgB,KAChB;MACH,MAAM,CAAC,CAACC,QAAQ,EAAEC,MAAM,CAAC,CAAC,GAAGF,IAAI;MACjC,IAAI,CAACG,IAAI,CAAC,YAAY,EAAE;QAAEF,QAAQ;QAAEC;MAAO,CAAC,CAAC;MAC7C,OAAOH,UAAU,CAAC,GAAGC,IAAI,CAAC;IAC5B,CAAC,EAAEI,IAAI,CACL,IAAI,EACJhB,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACU,kBAAkB,CAACC,IAAI,CAACM,IAAI,CAC5DhB,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACU,kBACpC,CACF,CAAC;IAEDT,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACG,aAAa,GAAG,IAAI;EACxD;EAEAe,SAASA,CAAA,EAAG;IACVjB,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACG,aAAa,GAAGgB,SAAS;IAC3DlB,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACU,kBAAkB,CAACC,IAAI,GACvDS,KAAK,CAACC,SAAS,CAACV,IAAI,CAACM,IAAI,CACvBhB,mBAAmB,CAACC,MAAM,CAACF,MAAM,CAACU,kBACpC,CAAC;EACL;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;EACEY,UAAUA,CAACC,OAAoB,EAAE;IAC/B,IAAI,CAACA,OAAO,GAAGA,OAAO;EACxB;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACEC,WAAWA,CACTC,QAA+B,EAC/B;IAAEC,QAAQ,GAAG;EAAmB,CAAC,GAAG,CAAC,CAAC,EACtC;IACA,IAAI,CAACpB,SAAS,GAAG,IAAI,CAACA,SAAS,CAC5BqB,MAAM,CAAC,CAAC,CAACD,QAAQ,EAAED,QAAQ,CAAC,CAAC,CAAC,CAC9BG,IAAI,CAAC,CAAC,CAACC,CAAC,CAAC,EAAE,CAACC,CAAC,CAAC,KAAKA,CAAC,GAAGD,CAAC,CAAC;EAC9B;;EAEA;AACF;AACA;AACA;AACA;AACA;EACEE,cAAcA,CAACN,QAA+B,EAAW;IACvD,MAAMO,KAAK,GAAG,IAAI,CAAC1B,SAAS,CAAC2B,SAAS,CAAC,CAAC,GAAGC,IAAI,CAAC,KAAKA,IAAI,KAAKT,QAAQ,CAAC;IACvE,IAAIO,KAAK,GAAG,CAAC,CAAC,EAAE;MACd,IAAI,CAAC1B,SAAS,CAAC6B,MAAM,CAACH,KAAK,EAAE,CAAC,CAAC;MAC/B,OAAO,IAAI;IACb;IAEA,OAAO,KAAK;EACd;;EAEA;AACF;AACA;EACEI,kBAAkBA,CAAA,EAAG;IACnB,IAAI,CAAC9B,SAAS,GAAG,EAAE;EACrB;EAEA,MAAgB+B,SAASA,CAAA,EAAG;IAC1B,IAAI,CAAC,IAAI,CAAChC,gBAAgB,EAAE;MAC1B,MAAMiC,UAAU,GAAG,MAAM,IAAI,CAACf,OAAO,EAAEgB,OAAO,CAAC1C,SAAS,CAAC;MACzD,IAAI,CAACO,KAAK,GAAGkC,UAAU,GAAGE,IAAI,CAACC,KAAK,CAACH,UAAU,CAAC,GAAG,CAAC,CAAC;MACrD,IAAI,CAACjC,gBAAgB,GAAG,IAAI;IAC9B;EACF;EAEA,MAAgBqC,SAASA,CAAA,EAAG;IAC1B,MAAM,IAAI,CAACnB,OAAO,EAAEoB,OAAO,CAAC9C,SAAS,EAAE2C,IAAI,CAACI,SAAS,CAAC,IAAI,CAACxC,KAAK,CAAC,CAAC;EACpE;EAEUyC,WAAWA,CAACC,KAAU,EAAEC,OAAe,EAAE,GAAGC,IAAW,EAAS;IACxEC,OAAO,CAACH,KAAK,CAACC,OAAO,EAAE,GAAGC,IAAI,EAAE;MAAEE,aAAa,EAAEJ;IAAM,CAAC,CAAC;IACzD,IAAI,CAAC9B,IAAI,CAAC,OAAO,EAAE;MAAE+B,OAAO;MAAEC,IAAI;MAAEE,aAAa,EAAEJ;IAAM,CAAC,CAAC;IAC3D,MAAMA,KAAK;EACb;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACE,MAAMK,aAAaA,CACjBrC,QAAgB,EAChBC,MAAe,EACfqC,cAAc,GAAG9D,iBAAiB,CAAC,CAAC,EACnB;IACjB,MAAM,IAAI,CAAC+C,SAAS,CAAC,CAAC;IACtB,IAAI;MACF,IAAI,CAAC,IAAI,CAAC/B,SAAS,CAAC+C,MAAM,EAAE;QAC1B,MAAM,IAAI5C,KAAK,CACb,iGACF,CAAC;MACH;MAEA,IAAI,CAACO,IAAI,CAAC,WAAW,EAAE;QAAEF,QAAQ;QAAEC;MAAO,CAAC,CAAC;MAE5C,IAAIuC,OAAO;MACX,KAAK,MAAM,GAAGC,OAAO,CAAC,IAAI,IAAI,CAACjD,SAAS,EAAE;QACxCgD,OAAO,GAAG,MAAMC,OAAO,CAACzC,QAAQ,EAAEC,MAAM,CAAC;QACzC,IAAIuC,OAAO,EAAE;UACX;QACF;MACF;MAEA,IAAI,CAACA,OAAO,EAAE;QACZ,MAAM,IAAI7C,KAAK,CAAC,0CAA0CK,QAAQ,EAAE,CAAC;MACvE;MAEA,IAAI,OAAOwC,OAAO,CAACE,GAAG,KAAK,UAAU,EAAE;QACrCF,OAAO,CAACE,GAAG,GAAGF,OAAO,CAACE,GAAG,CAACJ,cAAc,CAAC;MAC3C;MAEA,MAAMK,MAAM,GAAGlE,MAAM,CAACmE,IAAI,CAAC;QAAE5C,QAAQ;QAAEC;MAAO,CAAC,EAAEuC,OAAO,EAAE,KAAK,CAAC;MAChE,MAAMK,QAAQ,GAAGF,MAAM,CAACH,OAAO,CAACM,QAAQ;;MAExC;MACA,IAAIN,OAAO,CAACO,kBAAkB,EAAE;QAC9B;QACA,MAAMC,KAAK,GAAG,MAAMR,OAAO,CAACO,kBAAkB,CAC5C/C,QAAQ,EACRC,MAAM,EACN0C,MAAM,CAACM,iBAAiB,CAAC,IAAI,CAAC3D,KAAK,CAACuD,QAAQ,CAAC,CAC/C,CAAC;;QAED;QACA,IAAIG,KAAK,EAAE;UACTL,MAAM,CAACH,OAAO,CAACQ,KAAK,GAAG,IAAI;UAC3B,IAAI,CAAC1D,KAAK,CAACuD,QAAQ,CAAC,GAAGF,MAAM,CAACO,YAAY,CAAC,CAAC;UAC5C,MAAM,IAAI,CAACtB,SAAS,CAAC,CAAC;QACxB;QAEA,IAAI,CAAC1B,IAAI,CAAC,UAAU,EAAEyC,MAAM,CAACQ,QAAQ,CAAC,CAAC,CAAC;;QAExC;QACA,OAAOR,MAAM;MACf;;MAEA;MACA,IAAI,CAAC,IAAI,CAACrD,KAAK,CAACuD,QAAQ,CAAC,EAAE;QACzBF,MAAM,CAACH,OAAO,CAACQ,KAAK,GAAG,IAAI;QAC3B,IAAI,CAAC1D,KAAK,CAACuD,QAAQ,CAAC,GAAGF,MAAM,CAACO,YAAY,CAAC,CAAC;QAC5C,MAAM,IAAI,CAACtB,SAAS,CAAC,CAAC;MACxB,CAAC,MAAM,IAAIe,MAAM,CAACS,aAAa,CAAC,IAAI,CAAC9D,KAAK,CAACuD,QAAQ,CAAC,CAAC,EAAE;QACrDF,MAAM,CAACH,OAAO,CAACQ,KAAK,GAAG,IAAI;QAC3B,IAAI,CAAC1D,KAAK,CAACuD,QAAQ,CAAC,GAAGF,MAAM,CAACO,YAAY,CAAC,CAAC;QAC5C,MAAM,IAAI,CAACtB,SAAS,CAAC,CAAC;MACxB;MAEA,IAAI,CAAC1B,IAAI,CAAC,UAAU,EAAEyC,MAAM,CAACQ,QAAQ,CAAC,CAAC,CAAC;MAExC,OAAOR,MAAM;IACf,CAAC,CAAC,OAAOX,KAAK,EAAE;MACd,IAAI,CAACD,WAAW,CACdC,KAAK,EACL,wDAAwD,EACxD;QAAEhC,QAAQ;QAAEC;MAAO,CACrB,CAAC;IACH;EACF;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACE,MAAMoD,UAAUA,CACdrD,QAAgB,EAChBC,MAAe,EACfqC,cAAc,GAAG9D,iBAAiB,CAAC,CAAC,EACpC;IACA,IAAImE,MAAM,GAAG,MAAM,IAAI,CAACN,aAAa,CAACrC,QAAQ,EAAEC,MAAM,EAAEqC,cAAc,CAAC;IACvE,OAAO,MAAM,IAAIgB,OAAO,CAAO,CAACb,OAAO,EAAEc,MAAM,KAAK;MAClD,CAAC,YAAY;QACX,MAAMC,QAAQ,GAAIzD,IAA2C,IAAK;UAChE,IAAIA,IAAI,CAACC,QAAQ,KAAKA,QAAQ,IAAID,IAAI,CAACE,MAAM,KAAKA,MAAM,EAAE;YACxD,IAAI,CAACC,IAAI,CAAC,QAAQ,EAAEyC,MAAM,CAACQ,QAAQ,CAAC,CAAC,CAAC;YACtCV,OAAO,CAAC,CAAC;UACX;QACF,CAAC;QAED,IAAI;UACF,IAAI,CAACvC,IAAI,CAAC,SAAS,EAAEyC,MAAM,CAACQ,QAAQ,CAAC,CAAC,CAAC;UACvC,IAAI,CAACM,EAAE,CAAC,YAAY,EAAED,QAAQ,CAAC;UAC/B,MAAM,IAAI,CAAC9D,mBAAmB,CAAC2D,UAAU,CAACrD,QAAQ,EAAE2C,MAAM,CAACH,OAAO,CAAC;QACrE,CAAC,CAAC,OAAOR,KAAK,EAAE;UACd,MAAM;YAAE0B;UAAK,CAAC,GAAG1B,KAAiC;UAClD,IAAI,CAACD,WAAW,CACdC,KAAK,EACL,wCAAwC,EACxC0B,IAAI,GAAG,IAAIA,IAAI,GAAG,GAAG,EAAE,EACvBf,MAAM,CAACQ,QAAQ,CAAC,CAClB,CAAC;QACH,CAAC,SAAS;UACR,IAAI,CAACQ,cAAc,CAAC,YAAY,EAAEH,QAAQ,CAAC;QAC7C;MACF,CAAC,EAAE,CAAC,CAACI,KAAK,CAAE5B,KAAK,IAAK;QACpBuB,MAAM,CAACvB,KAAK,CAAC;MACf,CAAC,CAAC;IACJ,CAAC,CAAC;EACJ;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACE,MAAM6B,cAAcA,CAClB7D,QAAgB,EAChBC,MAAe,EACfqC,cAAc,GAAG9D,iBAAiB,CAAC,CAAC,EACpC;IACA,IAAImE,MAAM,GAAG,MAAM,IAAI,CAACN,aAAa,CAACrC,QAAQ,EAAEC,MAAM,EAAEqC,cAAc,CAAC;IAEvE,IAAI;MACF,IAAI,CAACpC,IAAI,CAAC,aAAa,EAAEyC,MAAM,CAACQ,QAAQ,CAAC,CAAC,CAAC;MAC3C,MAAM,IAAI,CAACzD,mBAAmB,CAACmE,cAAc,CAAC7D,QAAQ,EAAE2C,MAAM,CAACH,OAAO,CAAC;IACzE,CAAC,CAAC,OAAOR,KAAK,EAAE;MACd,MAAM;QAAE0B;MAAK,CAAC,GAAG1B,KAAiC;MAClD,IAAI,CAACD,WAAW,CACdC,KAAK,EACL,4CAA4C,EAC5C0B,IAAI,GAAG,IAAIA,IAAI,GAAG,GAAG,EAAE,EACvBf,MAAM,CAACQ,QAAQ,CAAC,CAClB,CAAC;IACH;EACF;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACE,MAAMW,iBAAiBA,CAACC,SAAmB,GAAG,EAAE,EAAE;IAChD,IAAI;MACF,MAAM,IAAI,CAACxC,SAAS,CAAC,CAAC;MAEtB,MAAMyC,GAAG,GAAGD,SAAS,CAACxB,MAAM,GAAGwB,SAAS,GAAGE,MAAM,CAACC,IAAI,CAAC,IAAI,CAAC5E,KAAK,CAAC;MAClE0E,GAAG,CAACG,OAAO,CAAEnE,QAAQ,IAAK,OAAO,IAAI,CAACV,KAAK,CAACU,QAAQ,CAAC,CAAC;MAEtD,MAAM,IAAI,CAAC4B,SAAS,CAAC,CAAC;MACtB,MAAM,IAAI,CAAClC,mBAAmB,CAACoE,iBAAiB,CAACC,SAAS,CAAC;MAE3D,IAAI,CAAC7D,IAAI,CAAC,aAAa,EAAE8D,GAAG,CAAC;MAC7B,OAAOA,GAAG;IACZ,CAAC,CAAC,OAAOhC,KAAK,EAAE;MACd,MAAM;QAAE0B;MAAK,CAAC,GAAG1B,KAAiC;MAClD,IAAI,CAACD,WAAW,CACdC,KAAK,EACL,+CAA+C,EAC/C0B,IAAI,GAAG,IAAIA,IAAI,GAAG,GAAG,EACvB,CAAC;IACH;EACF;AACF","ignoreList":[]}
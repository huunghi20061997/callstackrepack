{"version":3,"file":"Script.js","names":["shallowEqual","NormalizedScriptLocatorHTTPMethod","NormalizedScriptLocatorSignatureVerificationMode","Script","DEFAULT_TIMEOUT","getDevServerURL","scriptId","webpackContext","p","u","getFileSystemURL","getRemoteURL","url","options","excludeExtension","getScriptUniqueId","caller","prefix","from","key","locator","fetch","headers","Headers","forEach","value","toLowerCase","uniqueId","body","FormData","bodyObject","console","warn","JSON","stringify","URLSearchParams","undefined","Error","method","GET","absolute","timeout","query","toString","Object","keys","length","cache","verifyScriptSignature","OFF","constructor","shouldUpdateCache","cachedData","checkIfCacheDataOutdated","shouldRefetch","diffs","some","diff","getCacheData","toObject"],"sources":["../../../src/modules/ScriptManager/Script.ts"],"sourcesContent":["import shallowEqual from 'shallowequal';\nimport type { ScriptLocator, WebpackContext } from './types';\nimport {\n  NormalizedScriptLocator,\n  NormalizedScriptLocatorHTTPMethod,\n  NormalizedScriptLocatorSignatureVerificationMode,\n} from './NativeScriptManager';\n\n/**\n * Representation of a Script to load and execute, used by {@link ScriptManager}.\n *\n * When adding resolvers to `ScriptManager` in `ScriptManager.shared.addResolver(...)`, you can use\n * `Script.getDevServerURL(...)`, `Script.getFileSystemURL(...)` or `Script.getRemoteURL(...)`\n * to create a `url` for the script.\n *\n * Other methods are designed for internal use only.\n */\nexport class Script {\n  static DEFAULT_TIMEOUT = 30000; // 30s\n\n  /**\n   * Get URL of a script hosted on development server.\n   *\n   * @param scriptId Id of the script.\n   */\n  static getDevServerURL(scriptId: string) {\n    return (webpackContext: WebpackContext) =>\n      `${webpackContext.p}${webpackContext.u(scriptId)}`;\n  }\n\n  /**\n   * Get URL of a script stored on filesystem on the target mobile device.\n   *\n   * @param scriptId Id of the script.\n   */\n  static getFileSystemURL(scriptId: string) {\n    return (webpackContext: WebpackContext) =>\n      webpackContext.u(`file:///${scriptId}`);\n  }\n\n  /**\n   * Get URL of a script hosted on a remote server.\n   *\n   * By default `.chunk.bundle` extension will be added to the URL.\n   * If your script has different extension, you should pass `{ excludeExtension: true }` as 2nd argument.\n   *\n   * @param url A URL to remote location where the script is stored.\n   * @param options Additional options.\n   */\n  static getRemoteURL(\n    url: string,\n    options: { excludeExtension?: boolean } = {}\n  ) {\n    if (options.excludeExtension) {\n      return url;\n    }\n\n    return (webpackContext: WebpackContext) => webpackContext.u(url);\n  }\n\n  /**\n   * Get unique identifier for the script.\n   *\n   * Used to create unique identifier for the script, which serves as its key in the cache.\n   *\n   * @param scriptId Id of the script.\n   * @param caller Optional caller name to prefix the script id.\n   */\n  static getScriptUniqueId(scriptId: string, caller?: string) {\n    const prefix = caller ? caller + '_' : '';\n    return prefix + scriptId;\n  }\n\n  /**\n   * Create new instance of `Script` from non-normalized script locator data.\n   *\n   * @param locator Non-normalized locator data.\n   * @param fetch Initial flag for whether script should be fetched or not.\n   *\n   * @internal\n   */\n  static from(\n    key: { scriptId: string; caller?: string },\n    locator: ScriptLocator,\n    fetch: boolean\n  ) {\n    const headers: Record<string, string> = {};\n    new Headers(locator.headers).forEach((value: string, key: string) => {\n      headers[key.toLowerCase()] = value;\n    });\n\n    const uniqueId = Script.getScriptUniqueId(key.scriptId, key.caller);\n\n    let body: NormalizedScriptLocator['body'];\n    if (locator.body instanceof FormData) {\n      const bodyObject: Record<string, string> = {};\n      locator.body.forEach((value, key) => {\n        if (typeof value === 'string') {\n          bodyObject[key] = value;\n        } else {\n          console.warn('Script does not support File as FormData key in body');\n        }\n      });\n      body = JSON.stringify(bodyObject);\n    } else if (locator.body instanceof URLSearchParams) {\n      const bodyObject: Record<string, string> = {};\n      locator.body.forEach((value, key) => {\n        bodyObject[key] = value;\n      });\n      body = JSON.stringify(bodyObject);\n    } else {\n      body = locator.body ?? undefined;\n    }\n\n    if (typeof locator.url === 'function') {\n      throw new Error('Property url as a function is not support');\n    }\n\n    return new Script(\n      key.scriptId,\n      key.caller,\n      {\n        uniqueId,\n        method:\n          (locator.method as NormalizedScriptLocatorHTTPMethod) ??\n          NormalizedScriptLocatorHTTPMethod.GET,\n        url: locator.url,\n        absolute: locator.absolute ?? false,\n        timeout: locator.timeout ?? Script.DEFAULT_TIMEOUT,\n        query: new URLSearchParams(locator.query).toString() || undefined,\n        body,\n        headers: Object.keys(headers).length ? headers : undefined,\n        fetch: locator.cache === false ? true : fetch,\n        verifyScriptSignature:\n          (locator.verifyScriptSignature as NormalizedScriptLocatorSignatureVerificationMode) ??\n          NormalizedScriptLocatorSignatureVerificationMode.OFF,\n      },\n      locator.cache\n    );\n  }\n\n  /**\n   * Constructs new representation of a script.\n   *\n   * @param locator Normalized locator data.\n   * @param cache Flag whether use cache or not, `true` by default.\n   *\n   * @internal\n   */\n  constructor(\n    public readonly scriptId: string,\n    public readonly caller: string | undefined,\n    public readonly locator: NormalizedScriptLocator,\n    public readonly cache: boolean = true\n  ) {}\n\n  /**\n   * Check if the script was already cached and cache should be updated with new data.\n   *\n   * @param cachedData Cached data for the same script.\n   *\n   * @internal\n   */\n  shouldUpdateCache(\n    cachedData: Pick<\n      NormalizedScriptLocator,\n      'method' | 'url' | 'query' | 'headers' | 'body'\n    >\n  ) {\n    if (!this.cache || !cachedData) {\n      return false;\n    }\n\n    return this.checkIfCacheDataOutdated(cachedData);\n  }\n\n  /**\n   * Check if the script should be fetched again or reused,\n   * based on previous cached data.\n   *\n   * @param cachedData Cached data for the same script.\n   *\n   * @internal\n   */\n  shouldRefetch(\n    cachedData: Pick<\n      NormalizedScriptLocator,\n      'method' | 'url' | 'query' | 'headers' | 'body'\n    >\n  ) {\n    if (!this.cache) {\n      return true;\n    }\n\n    return this.checkIfCacheDataOutdated(cachedData);\n  }\n\n  /**\n   * Check if previous cached data is the same as the new one.\n   *\n   * @param cachedData Cached data for the same script.\n   *\n   * @internal\n   */\n  checkIfCacheDataOutdated(\n    cachedData: Pick<\n      NormalizedScriptLocator,\n      'method' | 'url' | 'query' | 'headers' | 'body'\n    >\n  ) {\n    const diffs = [\n      cachedData.method !== this.locator.method,\n      cachedData.url !== this.locator.url,\n      cachedData.query !== this.locator.query,\n      !shallowEqual(cachedData.headers, this.locator.headers),\n      cachedData.body !== this.locator.body,\n    ];\n\n    return diffs.some((diff) => diff);\n  }\n\n  /**\n   * Get object to store in cache.\n   *\n   * @internal\n   */\n  getCacheData() {\n    return {\n      method: this.locator.method,\n      url: this.locator.url,\n      query: this.locator.query,\n      headers: this.locator.headers,\n      body: this.locator.body,\n    };\n  }\n\n  toObject() {\n    return {\n      scriptId: this.scriptId,\n      caller: this.caller,\n      locator: this.locator,\n      cache: this.cache,\n    };\n  }\n}\n"],"mappings":"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","ignoreList":[]}
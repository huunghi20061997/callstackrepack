{"version":3,"file":"RepackTargetPlugin.js","names":["_path","_interopRequireDefault","require","_webpack","_RepackInitRuntimeModule","_RepackLoadScriptRuntimeModule","e","__esModule","default","RepackTargetPlugin","constructor","config","apply","compiler","globalObject","options","target","output","chunkLoading","chunkFormat","webpack","BannerPlugin","raw","entryOnly","banner","Template","asString","NormalModuleReplacementPlugin","resource","request","resolve","context","path","dirname","createData","hooks","compilation","tap","additionalTreeRuntimeRequirements","chunk","runtimeRequirements","add","RuntimeGlobals","startupOnlyAfter","addRuntimeModule","RepackInitRuntimeModule","chunkId","id","undefined","chunkLoadingGlobal","hmrEnabled","mode","hmr","runtimeRequirementInTree","for","loadScript","RepackLoadScriptRuntimeModule","exports"],"sources":["../../../../src/webpack/plugins/RepackTargetPlugin/RepackTargetPlugin.ts"],"sourcesContent":["import path from 'path';\nimport webpack from 'webpack';\nimport type { DevServerOptions, WebpackPlugin } from '../../../types';\nimport { RepackInitRuntimeModule } from './runtime/RepackInitRuntimeModule';\nimport { RepackLoadScriptRuntimeModule } from './runtime/RepackLoadScriptRuntimeModule';\n\n/**\n * {@link RepackTargetPlugin} configuration options.\n */\nexport interface RepackTargetPluginConfig\n  extends Pick<DevServerOptions, 'hmr'> {}\n\n/**\n * Plugin for tweaking the JavaScript runtime code to account for React Native environment.\n *\n * Globally available APIs differ with React Native and other target's like Web, so there are some\n * tweaks necessary to make the final bundle runnable inside React Native's JavaScript VM.\n *\n * @category Webpack Plugin\n */\nexport class RepackTargetPlugin implements WebpackPlugin {\n  /**\n   * Constructs new `RepackTargetPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config?: RepackTargetPluginConfig) {}\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: webpack.Compiler) {\n    const globalObject = 'self';\n    compiler.options.target = false;\n    compiler.options.output.chunkLoading = 'jsonp';\n    compiler.options.output.chunkFormat = 'array-push';\n    compiler.options.output.globalObject = globalObject;\n\n    // Normalize global object.\n    new webpack.BannerPlugin({\n      raw: true,\n      entryOnly: true,\n      banner: webpack.Template.asString([\n        `/******/ var ${globalObject} = ${globalObject} || this || new Function(\"return this\")() || ({}); // repackGlobal'`,\n        '/******/',\n      ]),\n    }).apply(compiler);\n\n    // Replace React Native's HMRClient.js with custom Webpack-powered DevServerClient.\n    new webpack.NormalModuleReplacementPlugin(\n      /react-native.*?([/\\\\]+)Libraries([/\\\\]+)Utilities([/\\\\]+)HMRClient\\.js$/,\n      function (resource) {\n        const request = require.resolve('../../../modules/DevServerClient');\n        const context = path.dirname(request);\n        resource.request = request;\n        resource.context = context;\n        resource.createData.resource = request;\n        resource.createData.context = context;\n      }\n    ).apply(compiler);\n\n    compiler.hooks.compilation.tap('RepackTargetPlugin', (compilation) => {\n      compilation.hooks.additionalTreeRuntimeRequirements.tap(\n        'RepackTargetPlugin',\n        (chunk, runtimeRequirements) => {\n          runtimeRequirements.add(webpack.RuntimeGlobals.startupOnlyAfter);\n\n          // Add code initialize Re.Pack's runtime logic.\n          compilation.addRuntimeModule(\n            chunk,\n            new RepackInitRuntimeModule({\n              chunkId: chunk.id ?? undefined,\n              globalObject,\n              chunkLoadingGlobal: compiler.options.output.chunkLoadingGlobal!,\n              hmrEnabled:\n                compilation.options.mode === 'development' && this.config?.hmr,\n            })\n          );\n        }\n      );\n\n      // Overwrite Webpack's default load script runtime code with Re.Pack's implementation\n      // specific to React Native.\n      compilation.hooks.runtimeRequirementInTree\n        .for(webpack.RuntimeGlobals.loadScript)\n        .tap('RepackTargetPlugin', (chunk) => {\n          compilation.addRuntimeModule(\n            chunk,\n            new RepackLoadScriptRuntimeModule(chunk.id ?? undefined)\n          );\n\n          // Return `true` to make sure Webpack's default load script runtime is not added.\n          return true;\n        });\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}
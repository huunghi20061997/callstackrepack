{"version":3,"file":"LoggerPlugin.js","names":["_webpack","_interopRequireDefault","require","_env","_logging","e","__esModule","default","LoggerPlugin","SUPPORTED_TYPES","constructor","config","output","undefined","console","reporters","push","ConsoleReporter","isWorker","level","isVerbose","file","FileReporter","filename","reporter","composeReporters","createEntry","issuer","type","args","timestamp","includes","Date","now","message","processEntry","entry","listener","process","apply","compiler","options","stats","devServerEnabled","webpack","ProgressPlugin","percentage","text","progress","value","label","platform","hooks","infrastructureLog","tap","thisCompilation","compilation","log","intercept","call","time","done","errors","warnings","toJson","all","timings","entires","length","map","error","moduleName","warning","filter","Boolean","statsEntry","toString","flush","stop","on","errorEntry","exports"],"sources":["../../../src/webpack/plugins/LoggerPlugin.ts"],"sourcesContent":["import webpack from 'webpack';\nimport { isVerbose, isWorker } from '../../env';\nimport {\n  composeReporters,\n  FileReporter,\n  ConsoleReporter,\n  Reporter,\n  LogEntry,\n  LogType,\n} from '../../logging';\nimport type { WebpackPlugin } from '../../types';\n\nexport type GenericFilter = Array<string | RegExp>;\n\n/**\n * {@link LoggerPlugin} configuration options.\n */\nexport interface LoggerPluginConfig {\n  /** Target application platform. */\n  platform: string;\n  /** Whether development server is running/enabled. */\n  devServerEnabled?: boolean;\n  /** Logging output config. */\n  output?: {\n    /** Whether to log to console. */\n    console?: boolean;\n    /** Absolute path to file to log messages to. */\n    file?: string;\n    /** Listener for new messages. */\n    listener?: (logEntry: LogEntry) => void;\n  };\n}\n\n/**\n * Logger plugin that handles all logging coming from the Webpack ecosystem, including compilation\n * progress as well as debug logs from other plugins and resolvers.\n *\n * @category Webpack Plugin\n */\nexport class LoggerPlugin implements WebpackPlugin {\n  private static SUPPORTED_TYPES: string[] = ['debug', 'info', 'warn', 'error'];\n\n  /** {@link Reporter} instance used to actually writing logs to terminal/file. */\n  readonly reporter: Reporter;\n\n  /**\n   * Constructs new `LoggerPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config: LoggerPluginConfig) {\n    if (this.config.output === undefined) {\n      this.config.output = { console: true };\n    }\n\n    const reporters = [];\n    if (this.config.output.console) {\n      reporters.push(\n        new ConsoleReporter({\n          isWorker: isWorker(),\n          level: isVerbose() ? 'verbose' : 'normal',\n        })\n      );\n    }\n    if (this.config.output.file) {\n      reporters.push(new FileReporter({ filename: this.config.output.file }));\n    }\n    this.reporter = composeReporters(reporters);\n  }\n\n  /**\n   * Create log entry from Webpack log message from {@link WebpackLogger}.\n   *\n   * @param issuer Issuer of the message.\n   * @param type Type of the message.\n   * @param args The body of the message.\n   * @param timestamp Timestamp when the message was recorder.\n   * @returns Log entry object or undefined when if message is invalid.\n   */\n  createEntry(\n    issuer: string,\n    type: string,\n    args: any[],\n    timestamp?: number\n  ): LogEntry | undefined {\n    if (LoggerPlugin.SUPPORTED_TYPES.includes(type)) {\n      return {\n        timestamp: timestamp ?? Date.now(),\n        issuer: issuer.includes('reactNativeAssetsLoader')\n          ? 'reactNativeAssetsLoader'\n          : issuer,\n        type: type as LogType,\n        message: args,\n      };\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Process log entry and pass it to {@link reporter} instance.\n   *\n   * @param entry Log entry to process\n   */\n  processEntry(entry: LogEntry) {\n    if (\n      !this.config.output?.console &&\n      !this.config.output?.file &&\n      !this.config.output?.listener\n    ) {\n      return;\n    }\n\n    this.reporter.process(entry);\n\n    if (this.config.output.listener) {\n      this.config.output.listener(entry);\n    }\n  }\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: webpack.Compiler) {\n    // Make sure webpack-cli doesn't print stats by default.\n    if (compiler.options.stats === undefined) {\n      compiler.options.stats = 'none';\n    }\n\n    if (this.config.devServerEnabled) {\n      new webpack.ProgressPlugin((percentage, message, text) => {\n        const entry = this.createEntry('LoggerPlugin', 'info', [\n          {\n            progress: {\n              value: percentage,\n              label: message,\n              message: text,\n              platform: this.config.platform,\n            },\n          },\n        ]);\n        if (entry) {\n          this.processEntry(entry);\n        }\n      }).apply(compiler);\n    }\n\n    compiler.hooks.infrastructureLog.tap(\n      'LoggerPlugin',\n      (issuer, type, args) => {\n        const entry = this.createEntry(issuer, type, args ?? []);\n        if (entry) {\n          this.processEntry(entry);\n        }\n        return true;\n      }\n    );\n\n    compiler.hooks.thisCompilation.tap('LoggerPlugin', (compilation) => {\n      compilation.hooks.log.intercept({\n        call: (issuer, { time, type, args }) => {\n          const entry = this.createEntry(issuer, type, args, time);\n          if (entry) {\n            this.processEntry(entry);\n          }\n        },\n      });\n    });\n\n    compiler.hooks.done.tap('LoggerPlugin', (stats) => {\n      if (this.config.devServerEnabled) {\n        const { time, errors, warnings } = stats.toJson({\n          all: false,\n          timings: true,\n          errors: true,\n          warnings: true,\n        });\n\n        let entires: Array<LogEntry | undefined> = [];\n        if (errors?.length) {\n          entires = [\n            this.createEntry('LoggerPlugin', 'error', [\n              'Failed to build bundle due to errors',\n            ]),\n            ...errors.map((error) =>\n              this.createEntry('LoggerPlugin', 'error', [\n                `Error in \"${error.moduleName}\": ${error.message}`,\n              ])\n            ),\n          ];\n        } else {\n          entires = [\n            this.createEntry('LoggerPlugin', 'info', [\n              warnings?.length ? 'Bundle built with warnings' : 'Bundle built',\n              { time },\n            ]),\n            ...(warnings?.map((warning) =>\n              this.createEntry('LoggerPlugin', 'warn', [\n                `Warning in \"${warning.moduleName}\": ${warning.message}`,\n              ])\n            ) ?? []),\n          ];\n        }\n\n        for (const entry of entires.filter(Boolean) as LogEntry[]) {\n          this.processEntry(entry);\n        }\n      } else {\n        const statsEntry = this.createEntry('LoggerPlugin', 'info', [\n          stats.toString('all'),\n        ]);\n        if (statsEntry) {\n          this.processEntry(statsEntry);\n        }\n      }\n\n      this.reporter.flush();\n      this.reporter.stop();\n    });\n\n    process.on('uncaughtException', (error) => {\n      const errorEntry = this.createEntry('LoggerPlugin', 'error', [error]);\n      if (errorEntry) {\n        this.processEntry(errorEntry);\n      }\n      this.reporter.flush();\n      this.reporter.stop();\n    });\n\n    process.on('exit', () => {\n      this.reporter.flush();\n      this.reporter.stop();\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}
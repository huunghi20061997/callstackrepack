{"version":3,"file":"ModuleFederationPlugin.js","names":["_webpack","require","_federated","ModuleFederationPlugin","constructor","config","reactNativeDeepImports","replaceRemotes","remote","startsWith","Federated","createRemote","Array","isArray","map","remoteItem","replaced","key","value","external","getDefaultSharedDependencies","react","SHARED_REACT","SHARED_REACT_NATIVE","adaptSharedDependencies","shared","sharedDependencyConfig","eager","singleton","requiredVersion","findSharedDependency","name","dependencies","find","item","Boolean","sharedReactNative","reactNativeEager","undefined","adjustedSharedDependencies","push","Object","assign","apply","compiler","remotes","sharedDependencies","container","exposes","filename","library","type","shareScope","remoteType","runtime","exports"],"sources":["../../../src/webpack/plugins/ModuleFederationPlugin.ts"],"sourcesContent":["import { Compiler, container } from 'webpack';\nimport type { WebpackPlugin } from '../../types';\nimport { Federated } from '../federated';\n\ntype ModuleFederationPluginOptions =\n  typeof container.ModuleFederationPlugin extends {\n    new (\n      options: infer O\n    ): InstanceType<typeof container.ModuleFederationPlugin>;\n  }\n    ? O\n    : never;\n\ntype ExtractObject<T> = T extends {}\n  ? T extends Array<any>\n    ? never\n    : T\n  : never;\n\ntype RemotesObject = ExtractObject<ModuleFederationPluginOptions['remotes']>;\n\ntype SharedDependencies = Exclude<\n  ModuleFederationPluginOptions['shared'],\n  undefined\n>;\n\ntype SharedObject = ExtractObject<SharedDependencies>;\n\ntype SharedConfig = SharedObject extends { [key: string]: infer U }\n  ? Exclude<U, string>\n  : never;\n\n/**\n * {@link ModuleFederationPlugin} configuration options.\n *\n * The fields and types are exactly the same as in `webpack.container.ModuleFederationPlugin`.\n *\n * You can check documentation for all supported options here: https://webpack.js.org/plugins/module-federation-plugin/\n */\nexport interface ModuleFederationPluginConfig\n  extends ModuleFederationPluginOptions {\n  /** Enable or disable adding React Native deep imports to shared dependencies */\n  reactNativeDeepImports?: boolean;\n}\n\n/**\n * Webpack plugin to configure Module Federation with platform differences\n * handled under the hood.\n *\n * Usually, you should use `Repack.plugin.ModuleFederationPlugin`\n * instead of `webpack.container.ModuleFederationPlugin`.\n *\n * `Repack.plugin.ModuleFederationPlugin` creates:\n * - default for `filename` option when `exposes` is defined\n * - default for `library` option when `exposes` is defined\n * - default for `shared` option with `react` and `react-native` dependencies\n * - converts `remotes` into `ScriptManager`-powered `promise new Promise` loaders\n *\n * You can overwrite all defaults by passing respective options.\n *\n * `remotes` will always be converted to ScriptManager`-powered `promise new Promise` loaders\n * using {@link Federated.createRemote}.\n *\n * @example Host example.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'host,\n * });\n * ```\n *\n * @example Host example with additional `shared` dependencies.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'host,\n *   shared: {\n *     react: Repack.Federated.SHARED_REACT,\n *     'react-native': Repack.Federated.SHARED_REACT,\n *     'react-native-reanimated': {\n *       singleton: true,\n *     },\n *   },\n * });\n * ```\n *\n * @example Container examples.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'app1',\n *   remotes: {\n *     module1: 'module1@https://example.com/module1.container.bundle',\n *   },\n * });\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'app2',\n *   remotes: {\n *     module1: 'module1@https://example.com/module1.container.bundle',\n *     module2: 'module1@dynamic',\n *   },\n * });\n * ```\n *\n * @category Webpack Plugin\n */\nexport class ModuleFederationPlugin implements WebpackPlugin {\n  constructor(private config: ModuleFederationPluginConfig) {\n    this.config.reactNativeDeepImports =\n      this.config.reactNativeDeepImports ?? true;\n  }\n\n  private replaceRemotes<T extends string | string[] | RemotesObject>(\n    remote: T\n  ): T {\n    if (typeof remote === 'string') {\n      return remote.startsWith('promise new Promise')\n        ? remote\n        : (Federated.createRemote(remote) as T);\n    }\n\n    if (Array.isArray(remote)) {\n      return remote.map((remoteItem) => this.replaceRemotes(remoteItem)) as T;\n    }\n\n    const replaced = {} as RemotesObject;\n    for (const key in remote as RemotesObject) {\n      const value = remote[key];\n      if (typeof value === 'string' || Array.isArray(value)) {\n        replaced[key] = this.replaceRemotes(value);\n      } else {\n        replaced[key] = {\n          ...value,\n          external: this.replaceRemotes(value.external),\n        };\n      }\n    }\n\n    return replaced as T;\n  }\n\n  private getDefaultSharedDependencies(): SharedObject {\n    return {\n      react: Federated.SHARED_REACT,\n      'react-native': Federated.SHARED_REACT_NATIVE,\n    };\n  }\n\n  /**\n   * As including 'react-native' as a shared dependency is not enough to support\n   * deep imports from 'react-native' (e.g. 'react-native/Libraries/Utilities/PixelRatio'),\n   * we need to add deep imports using an undocumented feature of ModuleFederationPlugin.\n   *\n   * When a dependency has a trailing slash, deep imports of that dependency will be correctly\n   * resolved by reaching out to the shared scope. This also ensures single instances of things\n   * like 'assetsRegistry'. Additionally, we mark every package from '@react-native' group as shared\n   * as well, as these are used by React Native too.\n   *\n   * Reference: https://stackoverflow.com/questions/65636979/wp5-module-federation-sharing-deep-imports\n   * Reference: https://github.com/webpack/webpack/blob/main/lib/sharing/resolveMatchedConfigs.js#L77-L79\n   *\n   * @param shared shared dependencies configuration from ModuleFederationPlugin\n   * @returns adjusted shared dependencies configuration\n   *\n   * @internal\n   */\n  private adaptSharedDependencies(\n    shared: SharedDependencies\n  ): SharedDependencies {\n    const sharedDependencyConfig = (eager?: boolean) => ({\n      singleton: true,\n      eager: eager ?? true,\n      requiredVersion: '*',\n    });\n\n    const findSharedDependency = (\n      name: string,\n      dependencies: SharedDependencies\n    ): SharedConfig | string | undefined => {\n      if (Array.isArray(dependencies)) {\n        return dependencies.find((item) =>\n          typeof item === 'string' ? item === name : Boolean(item[name])\n        );\n      } else {\n        return dependencies[name];\n      }\n    };\n\n    const sharedReactNative = findSharedDependency('react-native', shared);\n    const reactNativeEager =\n      typeof sharedReactNative === 'object'\n        ? sharedReactNative.eager\n        : undefined;\n\n    if (!this.config.reactNativeDeepImports || !sharedReactNative) {\n      return shared;\n    }\n\n    if (Array.isArray(shared)) {\n      const adjustedSharedDependencies = [...shared];\n      if (!findSharedDependency('react-native/', shared)) {\n        adjustedSharedDependencies.push({\n          'react-native/': sharedDependencyConfig(reactNativeEager),\n        });\n      }\n      if (!findSharedDependency('@react-native/', shared)) {\n        adjustedSharedDependencies.push({\n          '@react-native/': sharedDependencyConfig(reactNativeEager),\n        });\n      }\n      return adjustedSharedDependencies;\n    } else {\n      const adjustedSharedDependencies = { ...shared };\n      if (!findSharedDependency('react-native/', shared)) {\n        Object.assign(adjustedSharedDependencies, {\n          'react-native/': sharedDependencyConfig(reactNativeEager),\n        });\n      }\n      if (!findSharedDependency('@react-native/', shared)) {\n        Object.assign(adjustedSharedDependencies, {\n          '@react-native/': sharedDependencyConfig(reactNativeEager),\n        });\n      }\n      return adjustedSharedDependencies;\n    }\n  }\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    const remotes = Array.isArray(this.config.remotes)\n      ? this.config.remotes.map((remote) => this.replaceRemotes(remote))\n      : this.replaceRemotes(this.config.remotes ?? {});\n\n    const sharedDependencies = this.adaptSharedDependencies(\n      this.config.shared ?? this.getDefaultSharedDependencies()\n    );\n\n    new container.ModuleFederationPlugin({\n      exposes: this.config.exposes,\n      filename:\n        // TODO fix in a separate PR (jbroma)\n        // eslint-disable-next-line prettier/prettier\n        this.config.filename ?? this.config.exposes\n          ? `${this.config.name}.container.bundle`\n          : undefined,\n      library: this.config.exposes\n        ? {\n            name: this.config.name,\n            type: 'self',\n            ...this.config.library,\n          }\n        : undefined,\n      name: this.config.name,\n      shared: sharedDependencies,\n      shareScope: this.config.shareScope,\n      remotes,\n      remoteType: this.config.remoteType,\n      runtime: this.config.runtime,\n    }).apply(compiler);\n  }\n}\n"],"mappings":"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","ignoreList":[]}
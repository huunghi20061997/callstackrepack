{"version":3,"file":"ChunksToHermesBytecodePlugin.js","names":["_path","_interopRequireDefault","require","_fsExtra","_webpack","_utils","e","__esModule","default","ChunksToHermesBytecodePlugin","name","constructor","config","apply","compiler","logger","getInfrastructureLogger","enabled","debug","options","output","compareBeforeEmit","reactNativePath","path","join","context","hermesCLIPath","getHermesCLIPath","hooks","assetEmitted","tapPromise","stage","file","outputPath","shouldTransformAsset","ModuleFilenameHelpers","matchObject","test","include","exclude","bundlePath","sourceMapPath","useSourceMaps","fs","pathExists","sourceMap","hermesSourceMapPath","transformBundleToHermesBytecode","info","composeSourceMaps","packagerMapPath","compilerMapPath","exports"],"sources":["../../../../src/webpack/plugins/ChunksToHermesBytecodePlugin/ChunksToHermesBytecodePlugin.ts"],"sourcesContent":["import path from 'path';\nimport fs from 'fs-extra';\n\nimport { ModuleFilenameHelpers, Compiler } from 'webpack';\nimport type { Rule, WebpackPlugin } from '../../../types';\n\nimport {\n  composeSourceMaps,\n  getHermesCLIPath,\n  transformBundleToHermesBytecode,\n} from './utils';\n\n/**\n * {@link ChunksToHermesBytecodePlugin} configuration options.\n */\ninterface ChunksToHermesBytecodePluginConfig {\n  /**\n   * Whether the plugin is enabled.\n   *\n   * Since hermes compilation of chunks is not necessary for every build, this\n   * option allows one to enable/disable the plugin. Normally, you would only\n   * enable this plugin for production builds.\n   */\n  enabled: boolean;\n\n  /** Matching files will be converted to Hermes bytecode. */\n  test: Rule | Rule[];\n\n  /** Include matching files in conversion to Hermes bytecode. */\n  include?: Rule | Rule[];\n\n  /** Exclude matching files from conversion to Hermes bytecode. */\n  exclude?: Rule | Rule[];\n\n  /** Path to the Hermes compiler binary. */\n  hermesCLIPath?: string;\n\n  /** Path to React-Native package inside node_modules */\n  reactNativePath?: string;\n\n  /** Force enable `compareBeforeEmit` webpack output option which this plugin disables by default. */\n  compareBeforeEmit?: boolean;\n}\n\n/**\n * Enable Hermes bytecode compilation for the given chunks.\n * This plugin is intended to be used with the `webpack-bundle` command.\n * It will transform the bundle into Hermes bytecode and replace the original bundle with the bytecode.\n * It will also compose the source maps generated by webpack and Hermes.\n *\n * Note: This plugin should only be used for production builds.\n * It is not possible to use this plugin for development builds.\n *\n * Note: You should exclude `index.bundle` from being transformed.\n * The `index.bundle` file is transformed by `react-native` after enabling Hermes in your project.\n *\n * @example ```js\n * // webpack.config.mjs\n * import * as Repack from '@callstack/repack';\n *\n * // ...\n * plugins: [\n *   new Repack.ChunksToHermesBytecodePlugin({\n *    enabled: mode === 'production' && !devServer,\n *    test: /\\.(js)?bundle$/,\n *    exclude: /index.bundle$/,\n *   }),\n * ]\n * ```\n *\n * @category Webpack Plugin\n */\nexport class ChunksToHermesBytecodePlugin implements WebpackPlugin {\n  private readonly name = 'ChunksToHermesBytecodePlugin';\n\n  constructor(private config: ChunksToHermesBytecodePluginConfig) {}\n\n  apply(compiler: Compiler) {\n    const logger = compiler.getInfrastructureLogger(this.name);\n\n    if (!this.config.enabled) {\n      logger.debug('Skipping hermes compilation');\n      return;\n    }\n\n    /**\n     * This plugin will only transform assets that are emitted after the compilation.\n     * To ensure that asset is always emitted we disable the `compareBeforeEmit` option\n     * which is enabled by default in Webpack.\n     *\n     * `compareBeforeEmit` option is used to skip emitting assets that are identical to the\n     * ones present in build directory, which might result in transformation being\n     * skipped when there is a untransformed bundle present in the build directory.\n     */\n    compiler.options.output.compareBeforeEmit = !!this.config.compareBeforeEmit;\n\n    const reactNativePath =\n      this.config.reactNativePath ||\n      path.join(compiler.context, 'node_modules', 'react-native');\n\n    const hermesCLIPath =\n      this.config.hermesCLIPath || getHermesCLIPath(reactNativePath);\n\n    compiler.hooks.assetEmitted.tapPromise(\n      { name: this.name, stage: 10 },\n      async (file, { outputPath }) => {\n        const shouldTransformAsset = ModuleFilenameHelpers.matchObject(\n          {\n            test: this.config.test,\n            include: this.config.include,\n            exclude: this.config.exclude,\n          },\n          file\n        );\n\n        if (!shouldTransformAsset) {\n          return;\n        }\n\n        const bundlePath = path.join(outputPath, file);\n        const sourceMapPath = `${bundlePath}.map`;\n        const useSourceMaps = await fs.pathExists(sourceMapPath);\n\n        logger.debug(`Starting hermes compilation for asset: ${bundlePath}`);\n\n        const { sourceMap: hermesSourceMapPath } =\n          await transformBundleToHermesBytecode({\n            hermesCLIPath,\n            useSourceMaps,\n            bundlePath,\n          });\n\n        logger.info(`Asset transformed: ${file}`);\n\n        if (useSourceMaps) {\n          await composeSourceMaps({\n            reactNativePath,\n            packagerMapPath: sourceMapPath,\n            compilerMapPath: hermesSourceMapPath,\n          });\n\n          logger.info(`Asset sourceMap transformed: ${file}.map`);\n        }\n      }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}
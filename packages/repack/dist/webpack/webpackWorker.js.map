{"version":3,"file":"webpackWorker.js","names":["_nodePath","_interopRequireDefault","require","_nodeWorker_threads","_memfs","_webpack","_loadWebpackConfig","_utils","e","__esModule","default","main","cliOptions","platform","webpackEnvOptions","getWebpackEnvOptions","webpackConfig","loadWebpackConfig","config","webpackConfigPath","watchOptions","plugins","concat","webpack","ProgressPlugin","_1","_2","message","completed","total","exec","undefined","parentPort","postMessage","event","parseInt","compiler","fileSystem","memfs","createFsFromVolume","Volume","outputFileSystem","hooks","watchRun","tap","invalid","done","stats","outputDirectory","compilation","outputOptions","path","assets","getAssets","map","asset","data","readFileSync","join","name","filename","info","toJson","all","cached","children","modules","timings","hash","errors","warnings","watch","error","workerData","catch","process","exit"],"sources":["../../src/webpack/webpackWorker.ts"],"sourcesContent":["import path from 'node:path';\nimport { workerData, parentPort } from 'node:worker_threads';\nimport memfs from 'memfs';\nimport webpack from 'webpack';\nimport type { WebpackWorkerOptions } from '../types';\nimport { loadWebpackConfig } from './loadWebpackConfig';\nimport { getWebpackEnvOptions } from './utils';\n\nasync function main({ cliOptions, platform }: WebpackWorkerOptions) {\n  const webpackEnvOptions = getWebpackEnvOptions(cliOptions);\n  const webpackConfig = await loadWebpackConfig(\n    cliOptions.config.webpackConfigPath,\n    { ...webpackEnvOptions, platform }\n  );\n  const watchOptions = webpackConfig.watchOptions ?? {};\n\n  webpackConfig.plugins = (webpackConfig.plugins ?? []).concat(\n    new webpack.ProgressPlugin((_1, _2, message) => {\n      const [, completed, total] = /(\\d+)\\/(\\d+) modules/.exec(message) ?? [];\n      if (completed !== undefined && total !== undefined) {\n        parentPort?.postMessage({\n          event: 'progress',\n          completed: parseInt(completed, 10),\n          total: parseInt(total, 10),\n          message,\n        });\n      }\n    })\n  );\n\n  const compiler = webpack(webpackConfig);\n\n  const fileSystem = memfs.createFsFromVolume(new memfs.Volume());\n\n  // @ts-expect-error memfs is compatible enough\n  compiler.outputFileSystem = fileSystem;\n\n  compiler.hooks.watchRun.tap('webpackWorker', () => {\n    parentPort?.postMessage({ event: 'watchRun' });\n  });\n\n  compiler.hooks.invalid.tap('webpackWorker', () => {\n    parentPort?.postMessage({ event: 'invalid' });\n  });\n\n  compiler.hooks.done.tap('webpackWorker', (stats) => {\n    const outputDirectory = stats.compilation.outputOptions.path!;\n    const assets = stats.compilation.getAssets().map((asset) => {\n      const data = fileSystem.readFileSync(\n        path.join(outputDirectory, asset.name)\n      ) as Buffer;\n      return {\n        filename: asset.name,\n        data,\n        info: asset.info,\n      };\n    });\n    parentPort?.postMessage({\n      event: 'done',\n      assets,\n      stats: stats.toJson({\n        all: false,\n        cached: true,\n        children: true,\n        modules: true,\n        timings: true,\n        hash: true,\n        errors: true,\n        warnings: false,\n      }),\n    });\n  });\n\n  compiler.watch(watchOptions, (error) => {\n    if (error) {\n      parentPort?.postMessage({ event: 'error', error });\n    }\n  });\n}\n\nmain(workerData).catch((error) => {\n  parentPort?.postMessage({ event: 'error', error });\n  process.exit(1);\n});\n"],"mappings":"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","ignoreList":[]}
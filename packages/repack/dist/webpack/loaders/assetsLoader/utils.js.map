{"version":3,"file":"utils.js","names":["_path","_interopRequireDefault","require","_imageSize","_escapeStringRegexp","e","__esModule","default","getFilesInDirectory","dirname","fs","Promise","resolve","reject","readdir","error","results","filter","result","getScaleNumber","scaleKey","parseFloat","replace","readFile","filename","Error","getImageSize","resourcePath","resourceFilename","suffixPattern","info","imageSize","scaleMatch","path","basename","match","RegExp","escapeStringRegexp","scale","Number","isFinite","width","height"],"sources":["../../../../src/webpack/loaders/assetsLoader/utils.ts"],"sourcesContent":["import path from 'path';\nimport imageSize from 'image-size';\nimport escapeStringRegexp from 'escape-string-regexp';\nimport { LoaderContext } from 'webpack';\nimport { Options } from './options';\nimport type { ImageSize } from './types';\n\nexport function getFilesInDirectory(\n  dirname: string,\n  fs: LoaderContext<Options>['fs']\n) {\n  return new Promise<string[]>((resolve, reject) =>\n    fs.readdir(dirname, (error, results) => {\n      if (error) {\n        reject(error);\n      } else {\n        resolve(\n          (results as Array<any> | undefined)?.filter(\n            (result) => typeof result === 'string'\n          ) ?? []\n        );\n      }\n    })\n  );\n}\n\nexport function getScaleNumber(scaleKey: string) {\n  return parseFloat(scaleKey.replace(/[^\\d.]/g, ''));\n}\n\nexport function readFile(filename: string, fs: LoaderContext<Options>['fs']) {\n  return new Promise<string | Buffer>((resolve, reject) => {\n    fs.readFile(filename, (error, results) => {\n      if (error) {\n        reject(error);\n      } else if (results) {\n        resolve(results);\n      } else {\n        reject(\n          new Error(\n            `Read file operation on ${filename} returned empty content.`\n          )\n        );\n      }\n    });\n  });\n}\n\nexport function getImageSize({\n  resourcePath,\n  resourceFilename,\n  suffixPattern,\n}: {\n  resourcePath: string;\n  resourceFilename: string;\n  suffixPattern: string;\n}): ImageSize | undefined {\n  let info: ImageSize | undefined;\n  try {\n    info = imageSize(resourcePath);\n\n    const [, scaleMatch = ''] =\n      path\n        .basename(resourcePath)\n        .match(\n          new RegExp(`^${escapeStringRegexp(resourceFilename)}${suffixPattern}`)\n        ) ?? [];\n\n    if (scaleMatch) {\n      const scale = Number(scaleMatch.replace(/[^\\d.]/g, ''));\n\n      if (typeof scale === 'number' && Number.isFinite(scale)) {\n        info.width && (info.width /= scale);\n        info.height && (info.height /= scale);\n      }\n    }\n  } catch {\n    // Asset is not an image\n  }\n\n  return info;\n}\n"],"mappings":";;;;;;;;;AAAA,IAAAA,KAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,UAAA,GAAAF,sBAAA,CAAAC,OAAA;AACA,IAAAE,mBAAA,GAAAH,sBAAA,CAAAC,OAAA;AAAsD,SAAAD,uBAAAI,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAK/C,SAASG,mBAAmBA,CACjCC,OAAe,EACfC,EAAgC,EAChC;EACA,OAAO,IAAIC,OAAO,CAAW,CAACC,OAAO,EAAEC,MAAM,KAC3CH,EAAE,CAACI,OAAO,CAACL,OAAO,EAAE,CAACM,KAAK,EAAEC,OAAO,KAAK;IACtC,IAAID,KAAK,EAAE;MACTF,MAAM,CAACE,KAAK,CAAC;IACf,CAAC,MAAM;MACLH,OAAO,CACJI,OAAO,EAA6BC,MAAM,CACxCC,MAAM,IAAK,OAAOA,MAAM,KAAK,QAChC,CAAC,IAAI,EACP,CAAC;IACH;EACF,CAAC,CACH,CAAC;AACH;AAEO,SAASC,cAAcA,CAACC,QAAgB,EAAE;EAC/C,OAAOC,UAAU,CAACD,QAAQ,CAACE,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;AACpD;AAEO,SAASC,QAAQA,CAACC,QAAgB,EAAEd,EAAgC,EAAE;EAC3E,OAAO,IAAIC,OAAO,CAAkB,CAACC,OAAO,EAAEC,MAAM,KAAK;IACvDH,EAAE,CAACa,QAAQ,CAACC,QAAQ,EAAE,CAACT,KAAK,EAAEC,OAAO,KAAK;MACxC,IAAID,KAAK,EAAE;QACTF,MAAM,CAACE,KAAK,CAAC;MACf,CAAC,MAAM,IAAIC,OAAO,EAAE;QAClBJ,OAAO,CAACI,OAAO,CAAC;MAClB,CAAC,MAAM;QACLH,MAAM,CACJ,IAAIY,KAAK,CACP,0BAA0BD,QAAQ,0BACpC,CACF,CAAC;MACH;IACF,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ;AAEO,SAASE,YAAYA,CAAC;EAC3BC,YAAY;EACZC,gBAAgB;EAChBC;AAKF,CAAC,EAAyB;EACxB,IAAIC,IAA2B;EAC/B,IAAI;IACFA,IAAI,GAAG,IAAAC,kBAAS,EAACJ,YAAY,CAAC;IAE9B,MAAM,GAAGK,UAAU,GAAG,EAAE,CAAC,GACvBC,aAAI,CACDC,QAAQ,CAACP,YAAY,CAAC,CACtBQ,KAAK,CACJ,IAAIC,MAAM,CAAC,IAAI,IAAAC,2BAAkB,EAACT,gBAAgB,CAAC,GAAGC,aAAa,EAAE,CACvE,CAAC,IAAI,EAAE;IAEX,IAAIG,UAAU,EAAE;MACd,MAAMM,KAAK,GAAGC,MAAM,CAACP,UAAU,CAACV,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;MAEvD,IAAI,OAAOgB,KAAK,KAAK,QAAQ,IAAIC,MAAM,CAACC,QAAQ,CAACF,KAAK,CAAC,EAAE;QACvDR,IAAI,CAACW,KAAK,KAAKX,IAAI,CAACW,KAAK,IAAIH,KAAK,CAAC;QACnCR,IAAI,CAACY,MAAM,KAAKZ,IAAI,CAACY,MAAM,IAAIJ,KAAK,CAAC;MACvC;IACF;EACF,CAAC,CAAC,MAAM;IACN;EAAA;EAGF,OAAOR,IAAI;AACb","ignoreList":[]}